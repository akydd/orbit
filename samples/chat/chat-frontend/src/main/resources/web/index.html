<!DOCTYPE html>

<html lang="en">
<head>
    <title>Bigger Chat Sample</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.css" rel="stylesheet">
    <script src="js/jquery-1.11.2.min.js"></script>
    <script src="js/underscore-min.js"></script>
    <style type="text/css">
        .messages {
            overflow-y: scroll;
            height: 300px;
        }
    </style>

    <script>
        var wsocket;
        var $nickName;
        var $message;
        var $chatWindow;
        var room = '';
        var serviceLocation;
        var pendingMessages = [];

        var parser = document.createElement('a');
        parser.href = window.location.href;
        var serviceLocation = (parser.protocol=="https" ? "wss" : "ws") +"://"+parser.host+"/sample/chat";

        function onMessageReceived(evt) {
            console.log("received: " + evt.data);
            var recv = JSON.parse(evt.data);
            // todo: escape?
            if(recv.user || recv.message) {
                showMessage(recv);
            } else if (recv.history) {
                showHistory(recv);
            } else if (recv.users) {
                showUsers(recv);
            } else if (recv.login) {
                addUser(recv);
            } else if (recv.logout) {
                removeUser(recv);
            } else {
                console.log("unhandled message type:" + JSON.stringify(recv));
            }
//            var sHeight = $('.panel-body')[0].scrollHeight;
//            $('.panel-body').scrollTop(sHeight);
        }

        function showMessage(recv) {
            var msg = recv;
            var dateString = "";
            var date = new Date(msg.received);
            if( !isNaN(date.getTime()) )
            {
                dateString = date.toLocaleString();
            }
            var $messageLine = $(
                    '<tr><td class="date">' + dateString
                    + '</td><td class="user">' + msg.nickName
                    + '</td><td class="message">' + msg.message
                    + '</td></tr>');
            $chatWindow.append($messageLine);
        }

        function showHistory(recv) {
            $chatWindow.empty();
            _.each(recv.history, function(msg) {
                var date = new Date(msg.received);
                if( !isNaN(date.getTime()) )
                {
                    dateString = date.toLocaleString();
                }
                var $messageLine = $(
                        '<tr><td class="date">' + dateString
                        + '</td><td class="user">' + msg.nickName
                        + '</td><td class="message">' + msg.message
                        + '</td></tr>');
                $chatWindow.append($messageLine);
            });
        }

        function showUsers(recv) {
            _.each(recv.users, function(userObject) {
                var userHtml = "<tr id='" + userObject.user + "'><td>" + userObject.user + "</td></tr>";
                $('#users').append(userHtml);
            });
        }

        function addUser(recv) {
            var userHtml = "<tr id='" + recv.login + "'><td>" + recv.login + "</td></tr>";
            $('#users').append(userHtml);
        }

        function removeUser(recv) {
            $('#' + recv.logout).remove();
        }

        function sendMessage() {
            var msg = {
                "type": "chatMessage",
                "message": $message.val(),
                "nickName": $nickName.val()
            };
            if(!wsocket) {
                pendingMessages.push(msg);
                connectToServer();
            }
            else {
                wsocket.send(JSON.stringify(msg));
            }
            $message.val('').focus();
        }

        function sendLogin() {
            var msg = {
                "type": "loginMessage",
                "nickname": $nickName.val()
            };
            if(!wsocket) {
                pendingMessages.push(msg);
                connectToServer();
            }
            else {
                wsocket.send(JSON.stringify(msg));
            }
        }

        function sendLogout() {
            var msg = {
                "type": "logoutMessage",
                "nickname": $nickName.val()
            };
            wsocket.send(JSON.stringify(msg));
        }

        function connectToServer() {
            console.log("connecting to server");
            // room = $('#chatroom option:selected').val();
            wsocket = new WebSocket(serviceLocation);
            wsocket.onmessage = onMessageReceived;
            wsocket.onclose = onClose;
            wsocket.onopen = onOpen;
        }

        function onOpen() {
            if(pendingMessages.length > 0) {
                var messages = pendingMessages;
                pendingMessages = [];
                for(var i=0; i<messages.length; i++) {
                    wsocket.send(JSON.stringify(messages[i]));
                }
            }
        }

        function onClose() {
            wsocket = null;
            $('.main').hide();
            $('#users').html("");
            $('.signin-form').show();
            $nickName.focus();
        }

        function signOut() {
            sendLogout();
        }

        $(document).ready(function () {
            $nickName = $('#nickname');
            $message = $('#message');
            $chatWindow = $('#response');
            $('.main').hide();
            $('.signUp-form').hide();
            $nickName.focus();

            $('#enterRoom').click(function (evt) {
                evt.preventDefault();
                $('.chat-container h2').text('Chat # ' + $nickName.val() + "@" + room);
                $('.chat-container').show();
                $message.focus();
            });

            $('#signUp-link').click(function() {
                $('#signIn-form').hide();
                $('#signUp-form').show();
            });

            $('#signIn').click(function (evt) {
                evt.preventDefault();
                sendLogin();

                // TODO: do this on login success
                $('#signUp-form').hide();
                $('.main').show();

//                $('.chat-container h2').text('Chat # ' + $nickName.val());
                $message.focus();
            });

            $('#signUp').click(function (e) {
                e.preventDefault();
                // sendSignUp();

                // TODO: do this on signUp success
                $('#signUp-form').hide();
                $('.main').show();

//                $('.chat-container h2').text('Chat # ' + $nickName.val());
                $message.focus();
            });

            $('#do-chat').submit(function (evt) {
                evt.preventDefault();
                sendMessage()
            });

            $('#sign-out').click(function () {
                signOut();
            });
        });
    </script>
</head>

<body>

<div class="container" id="signUp-form">
    <form role="form">
        <h2>Sign Up</h2>

        <div class="form-group">
            <label for="newName">Nickname</label>
            <input type="text" class="form-control" id="newName" placeholder="Nickname">
            <input type="password" class="form-control" id="newPassword">
        </div>

        <div class="form-group">
            <button class="btn btn-primary" type="submit" id="signUp">Sign Up</button>
        </div>
    </form>
</div>


<div class="container" id="signIn-form">
    <form role="form">
        <h2>Sign In</h2>

        <div class="form-group">
            <label for="nickname">Nickname</label>
            <input type="text" class="form-control" id="nickname" placeholder="Nickname">
        </div>

        <div class="form-group">
            <button class="btn btn-primary" type="submit" id="signIn">Sign In</button>
        </div>
    </form>
    <h3 id="signUp-link"><a>New user?</a></h3>
</div>

<div class="main container">
    <h2></h2>

    <div class="row">
        <div class="col-md-2">
            <div>
                <h3>People</h3>
                <table id="users-table" class="table">
                    <tbody id="users">
                    </tbody>
                </table>
            </div>
            <div>
                <h3>Rooms</h3>
                <select size="1" id="chatroom" class="form-control">
                    <option>mass effect</option>
                    <option>dragon age</option>
                    <option>battlefield</option>
                    <option>fifa</option>
                </select>
            </div>
        </div>

        <div class="col-md-8 chat-window">
            <div class="panel-body messages">
                <table>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <footer class="footer">
                <legend>Enter your message..</legend>
                <div class="controls">
                    <input type="text" class="form-control" placeholder="message..." id="message"
                           style="height:6em; margin-bottom: 0.5ex"/>
                    <input type="submit" class="btn btn-large btn-block btn-primary"
                           value="Send message"/>
                    <button class="btn btn-large btn-block" type="button" id="sign-out">Sign out</button>
                </div>
            </footer>
        </div>

        <div class="col-md-2">
        </div>
    </div>
</div>

<!--<div class="container chat-container">-->
    <!--<form id="do-chat">-->
        <!--<h2 class="alert alert-success"></h2>-->

        <!--<div class="panel-body">-->
            <!--<table id="response" class="table">-->
            <!--</table>-->
        <!--</div>-->

        <!--<div class="panel-body">-->
            <!--<table id="private" class="table">-->
            <!--</table>-->
        <!--</div>-->
    <!--</form>-->
<!--</div>-->
</body>
</html>